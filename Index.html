<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BebCom Lounge - Delivery com Pagamento</title>
    <meta name="description" content="Sistema de delivery com pagamento PIX, cart√£o e dinheiro">
    <meta name="author" content="BebCom Lounge">
    
    <style>
        /* ESTILOS GERAIS */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        h1 {
            color: #4d96ff;
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .tagline {
            color: #aaa;
            font-size: 1rem;
        }

        /* PRODUTOS */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .product-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
            border-color: #4d96ff;
        }

        .product-image {
            width: 80px;
            height: 80px;
            margin: 0 auto 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
        }

        .product-name {
            font-weight: 600;
            margin-bottom: 5px;
            color: #fff;
        }

        .product-price {
            color: #4d96ff;
            font-weight: bold;
            font-size: 1.2rem;
            margin-bottom: 10px;
        }

        .add-to-cart {
            background: linear-gradient(135deg, #4d96ff 0%, #357abd 100%);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            width: 100%;
        }

        .add-to-cart:hover {
            background: linear-gradient(135deg, #357abd 0%, #2a5f9a 100%);
            transform: scale(1.05);
        }

        /* CARRINHO */
        .cart {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-top: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: none;
        }

        .cart.show {
            display: block;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .cart h2 {
            color: #4d96ff;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .cart-items {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .item-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .item-controls button {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .item-controls span {
            min-width: 30px;
            text-align: center;
        }

        .cart-input {
            width: 100%;
            padding: 12px 15px;
            margin: 8px 0;
            background: rgba(255, 255, 255, 0.07);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            font-size: 14px;
        }

        .cart-input:focus {
            outline: none;
            border-color: #4d96ff;
            background: rgba(255, 255, 255, 0.1);
        }

        .location-btn {
            background: linear-gradient(135deg, #6bcf7f 0%, #4caF50 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            width: 100%;
            margin: 10px 0;
        }

        .location-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(107, 207, 127, 0.3);
        }

        .cart-total {
            text-align: right;
            font-size: 1.2rem;
            font-weight: bold;
            margin: 10px 0;
            padding: 10px;
            border-top: 2px solid rgba(255, 255, 255, 0.1);
        }

        /* PAGAMENTO */
        .payment-section {
            margin: 15px 0;
            animation: slideIn 0.5s ease;
        }

        .payment-method {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
            padding: 15px;
            background: rgba(45, 45, 45, 0.5);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .payment-method:hover {
            background: rgba(45, 45, 45, 0.8);
        }

        .payment-method.selected {
            border-color: #4d96ff;
            background: rgba(77, 150, 255, 0.1);
        }

        .payment-icon {
            font-size: 24px;
            margin-right: 10px;
        }

        .pay-button {
            background: linear-gradient(135deg, #28a745 0%, #218838 100%);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            width: 100%;
            transition: all 0.3s ease;
            margin: 15px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .pay-button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(40, 167, 69, 0.4);
        }

        .pay-button:disabled {
            background: #666;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .payment-status {
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            background: rgba(255, 217, 61, 0.1);
            border-left: 4px solid #ffd93d;
            font-size: 14px;
            text-align: center;
            animation: slideIn 0.3s ease;
        }

        .payment-status.success {
            background: rgba(107, 207, 127, 0.1);
            border-left-color: #6bcf7f;
        }

        .payment-status.error {
            background: rgba(220, 38, 38, 0.1);
            border-left-color: #dc2626;
        }

        .payment-loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* BOT√ïES */
        .checkout-button {
            background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            width: 100%;
            transition: all 0.3s ease;
            margin: 10px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .checkout-button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(37, 211, 102, 0.4);
        }

        .checkout-button:disabled {
            background: #666;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .clear-cart-button {
            background: rgba(220, 38, 38, 0.2);
            color: #ff6b6b;
            border: 1px solid rgba(220, 38, 38, 0.3);
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .clear-cart-button:hover {
            background: rgba(220, 38, 38, 0.3);
        }

        /* RESPONSIVO */
        @media (max-width: 768px) {
            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            
            .container {
                padding: 10px;
            }
            
            header {
                padding: 15px;
            }
            
            h1 {
                font-size: 1.5rem;
            }
        }

        /* UTILIT√ÅRIOS */
        .hidden {
            display: none !important;
        }

        .info-message {
            background: rgba(59, 130, 246, 0.1);
            border-left: 4px solid #3b82f6;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
        }

        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border-left: 4px solid #ef4444;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">üçπ</div>
            <h1>BebCom Lounge Delivery</h1>
            <p class="tagline">Seu momento, nossa companhia ‚Ä¢ Pagamento via PIX, Cart√£o ou Dinheiro</p>
        </header>

        <!-- PRODUTOS -->
        <section class="products-section">
            <h2 style="margin-bottom: 15px; color: #fff;">üìã Nossas Bebidas</h2>
            <div class="products-grid" id="products-grid">
                <!-- Produtos ser√£o carregados via JavaScript -->
            </div>
        </section>

        <!-- CARRINHO -->
        <div class="cart" id="cart">
            <h2>üõí Carrinho</h2>
            <div class="cart-items" id="cart-items"></div>
            
            <div id="delivery-info" class="hidden">
                <div class="info-message">
                    üìè <strong>Dist√¢ncia:</strong> <span id="delivery-distance">0</span> km<br>
                    üöö <strong>Taxa de Entrega:</strong> R$<span id="delivery-fee">0.00</span>
                </div>
            </div>
            
            <div class="cart-total">
                üí∞ <strong>Subtotal:</strong> R$<span id="cart-subtotal">0.00</span>
            </div>
            <div class="cart-total hidden" id="total-with-delivery">
                üí≥ <strong>Total Geral:</strong> R$<span id="cart-total">0.00</span>
            </div>
            
            <!-- Nome do cliente -->
            <input type="text" id="customer-name" class="cart-input" 
                   placeholder="üë§ Digite seu nome completo" required
                   title="Nome completo para entrega">
            
            <!-- Tipo de pedido -->
            <div style="margin: 15px 0;">
                <label style="color: white; display: block; margin-bottom: 8px; font-weight: 500;">
                    üì¶ Como deseja receber?
                </label>
                <select id="order-type" class="cart-input" onchange="toggleDeliveryFields()">
                    <option value="pickup">üè™ Retirar na Loja</option>
                    <option value="delivery">üöö Entrega no Endere√ßo</option>
                </select>
            </div>
            
            <!-- Se√ß√£o de endere√ßo (aparece apenas para entrega) -->
            <div id="address-section" class="hidden">
                <label style="color: white; display: block; margin-bottom: 8px; font-weight: 500;">
                    üìç Como fornecer o endere√ßo?
                </label>
                <select id="address-method" class="cart-input" onchange="toggleAddressMethod()">
                    <option value="gps">üìç Usar minha localiza√ß√£o GPS</option>
                    <option value="manual">‚úèÔ∏è Digitar endere√ßo manualmente</option>
                </select>
                
                <div id="manual-address-section" class="hidden">
                    <input type="text" id="customer-address" class="cart-input" 
                           placeholder="üè† Digite: Rua, N√∫mero, Bairro, Cidade"
                           title="Endere√ßo completo para entrega">
                </div>
                
                <div id="gps-section" class="hidden">
                    <button type="button" class="location-btn" onclick="getUserLocation()">
                        üìç Obter minha localiza√ß√£o automaticamente
                    </button>
                    <div id="location-info" class="info-message hidden">
                        ‚úÖ Localiza√ß√£o obtida com sucesso!
                    </div>
                </div>
            </div>
            
            <!-- SE√á√ÉO DE PAGAMENTO -->
            <div class="payment-section" id="payment-section">
                <h3 style="color: white; margin-bottom: 15px;">üí∞ M√©todo de Pagamento</h3>
                
                <div class="payment-method" onclick="selectPaymentMethod('pix')">
                    <input type="radio" id="pix-method" name="payment-method" value="pix">
                    <div class="payment-icon">üßæ</div>
                    <div>
                        <label for="pix-method" style="font-weight: bold;">PIX Online</label>
                        <div style="font-size: 12px; color: #aaa;">Pagamento instant√¢neo via QR Code</div>
                    </div>
                </div>
                
                <div class="payment-method" onclick="selectPaymentMethod('cash')">
                    <input type="radio" id="cash-method" name="payment-method" value="cash">
                    <div class="payment-icon">üíµ</div>
                    <div>
                        <label for="cash-method" style="font-weight: bold;">Dinheiro</label>
                        <div style="font-size: 12px; color: #aaa;">Na entrega ou retirada</div>
                    </div>
                </div>
                
                <div class="payment-method" onclick="selectPaymentMethod('card')">
                    <input type="radio" id="card-method" name="payment-method" value="card">
                    <div class="payment-icon">üí≥</div>
                    <div>
                        <label for="card-method" style="font-weight: bold;">Cart√£o</label>
                        <div style="font-size: 12px; color: #aaa;">Na entrega ou retirada (d√©bito/cr√©dito)</div>
                    </div>
                </div>
                
                <div id="payment-status" class="payment-status hidden"></div>
                
                <button class="pay-button" id="pay-button" onclick="processPayment()" disabled>
                    <span id="pay-button-text">üí∞ Realizar Pagamento</span>
                </button>
            </div>
            
            <!-- BOT√ïES FINAIS -->
            <button class="checkout-button" id="checkout-button" onclick="sendToWhatsApp()" disabled>
                üì± Enviar Pedido para WhatsApp
            </button>
            
            <button class="clear-cart-button" onclick="clearCart()">
                üóëÔ∏è Limpar Carrinho e Come√ßar Novamente
            </button>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURA√á√ïES (AGORA MAIS SEGURAS)
        // ============================================
        let CONFIG = {
            whatsappNumber: '5514996130369', // Ser√° carregado da API
            paymentApiUrl: 'https://bebcom-payments.onrender.com',
            storeLocation: {
                lat: -22.893485,
                lng: -48.443925,
                address: 'Rua Exemplo, 123 - Centro, Bauru/SP'
            },
            deliveryRates: {
                baseFee: 5.00,
                perKm: 2.50,
                maxDistance: 15,
                freeDeliveryMin: 50.00
            }
        };

        // ============================================
        // ESTADO GLOBAL DA APLICA√á√ÉO
        // ============================================
        let state = {
            cart: [],
            userLocation: null,
            selectedPaymentMethod: null,
            paymentConfirmed: false,
            paymentProcessing: false,
            configLoaded: false
        };

        // ============================================
        // PRODUTOS (DADOS MOCK - pode vir de API)
        // ============================================
        const PRODUCTS = [
            { id: 1, name: "Caipirinha de Lim√£o", price: 18.90, emoji: "üçã" },
            { id: 2, name: "Caipirinha de Morango", price: 19.90, emoji: "üçì" },
            { id: 3, name: "Caipirinha de Abacaxi", price: 19.90, emoji: "üçç" },
            { id: 4, name: "Mojito Tradicional", price: 22.90, emoji: "üåø" },
            { id: 5, name: "Sex on the Beach", price: 24.90, emoji: "üèñÔ∏è" },
            { id: 6, name: "Margarita", price: 23.90, emoji: "üç∏" },
            { id: 7, name: "Pi√±a Colada", price: 25.90, emoji: "üçπ" },
            { id: 8, name: "Cerveja Heineken", price: 12.90, emoji: "üç∫" },
            { id: 9, name: "Cerveja Stella", price: 13.90, emoji: "üçª" },
            { id: 10, name: "Refrigerante Lata", price: 6.90, emoji: "ü•§" },
            { id: 11, name: "√Ågua com G√°s", price: 5.90, emoji: "üíß" },
            { id: 12, name: "Suco Natural", price: 10.90, emoji: "üßÉ" }
        ];

        // ============================================
        // FUN√á√ïES DE INICIALIZA√á√ÉO
        // ============================================
        async function initializeApp() {
            try {
                // Carregar configura√ß√µes da API
                await loadConfig();
                
                // Renderizar produtos
                renderProducts();
                
                // Configurar event listeners
                setupEventListeners();
                
                // Inicializar UI
                updateCart();
                toggleDeliveryFields();
                
                console.log('‚úÖ Aplica√ß√£o inicializada com sucesso');
            } catch (error) {
                console.error('Erro na inicializa√ß√£o:', error);
                showError('Erro ao carregar aplica√ß√£o. Recarregue a p√°gina.');
            }
        }

        async function loadConfig() {
            try {
                // Tentar carregar da API local
                const response = await fetch('/api/config');
                if (response.ok) {
                    const apiConfig = await response.json();
                    CONFIG.whatsappNumber = apiConfig.whatsappNumber;
                    CONFIG.storeLocation = apiConfig.storeLocation;
                }
                state.configLoaded = true;
            } catch (error) {
                console.log('Usando configura√ß√£o local');
                state.configLoaded = true;
            }
        }

        function renderProducts() {
            const grid = document.getElementById('products-grid');
            grid.innerHTML = '';
            
            PRODUCTS.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                productCard.onclick = () => addToCart(product);
                
                productCard.innerHTML = `
                    <div class="product-image">${product.emoji}</div>
                    <div class="product-name">${product.name}</div>
                    <div class="product-price">R$ ${product.price.toFixed(2)}</div>
                    <button class="add-to-cart">+ Adicionar</button>
                `;
                
                grid.appendChild(productCard);
            });
        }

        function setupEventListeners() {
            // Valida√ß√£o em tempo real do nome
            document.getElementById('customer-name').addEventListener('input', validateForm);
            
            // Valida√ß√£o do endere√ßo manual
            document.getElementById('customer-address').addEventListener('blur', function() {
                if (document.getElementById('order-type').value === 'delivery' && 
                    document.getElementById('address-method').value === 'manual') {
                    calculateDeliveryFeeFromAddress();
                }
                validateForm();
            });
            
            // Evento para mostrar/esconder carrinho
            document.addEventListener('click', function(event) {
                if (!event.target.closest('.cart') && !event.target.closest('.product-card') && 
                    !event.target.closest('.add-to-cart')) {
                    if (state.cart.length > 0) {
                        document.getElementById('cart').classList.add('show');
                    }
                }
            });
        }

        // ============================================
        // FUN√á√ïES DO CARRINHO
        // ============================================
        function addToCart(product) {
            const existingItem = state.cart.find(item => item.id === product.id);
            
            if (existingItem) {
                existingItem.quantity++;
            } else {
                state.cart.push({
                    ...product,
                    quantity: 1
                });
            }
            
            updateCart();
            showCart();
            validateForm();
        }

        function removeFromCart(productId) {
            state.cart = state.cart.filter(item => item.id !== productId);
            updateCart();
            validateForm();
        }

        function updateCartQuantity(productId, change) {
            const item = state.cart.find(item => item.id === productId);
            
            if (item) {
                item.quantity += change;
                
                if (item.quantity < 1) {
                    removeFromCart(productId);
                } else {
                    updateCart();
                }
            }
        }

        function updateCart() {
            const cartItems = document.getElementById('cart-items');
            const subtotal = calculateSubtotal();
            
            cartItems.innerHTML = '';
            
            if (state.cart.length === 0) {
                cartItems.innerHTML = '<div class="info-message">üõí Seu carrinho est√° vazio</div>';
                document.getElementById('cart').classList.remove('show');
            } else {
                state.cart.forEach(item => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'cart-item';
                    
                    itemElement.innerHTML = `
                        <div>
                            <strong>${item.name}</strong><br>
                            <small>R$ ${item.price.toFixed(2)} cada</small>
                        </div>
                        <div class="item-controls">
                            <button onclick="updateCartQuantity(${item.id}, -1)" title="Remover um">‚àí</button>
                            <span>${item.quantity}</span>
                            <button onclick="updateCartQuantity(${item.id}, 1)" title="Adicionar mais">+</button>
                            <span style="margin-left: 15px; min-width: 60px;">
                                R$ ${(item.price * item.quantity).toFixed(2)}
                            </span>
                        </div>
                    `;
                    
                    cartItems.appendChild(itemElement);
                });
                
                document.getElementById('cart').classList.add('show');
            }
            
            document.getElementById('cart-subtotal').textContent = subtotal.toFixed(2);
            
            // Atualizar total com entrega se necess√°rio
            if (document.getElementById('order-type').value === 'delivery') {
                updateDeliveryTotal();
            }
        }

        function calculateSubtotal() {
            return state.cart.reduce((total, item) => total + (item.price * item.quantity), 0);
        }

        function clearCart() {
            if (state.cart.length === 0) return;
            
            if (confirm('Tem certeza que deseja limpar o carrinho?')) {
                state.cart = [];
                state.selectedPaymentMethod = null;
                state.paymentConfirmed = false;
                
                updateCart();
                resetPaymentUI();
                validateForm();
                
                // Resetar campos
                document.getElementById('customer-name').value = '';
                document.getElementById('customer-address').value = '';
                document.getElementById('order-type').value = 'pickup';
                
                toggleDeliveryFields();
            }
        }

        function showCart() {
            document.getElementById('cart').classList.add('show');
        }

        // ============================================
        // FUN√á√ïES DE LOCALIZA√á√ÉO E ENTREGA
        // ============================================
        function toggleDeliveryFields() {
            const orderType = document.getElementById('order-type').value;
            const addressSection = document.getElementById('address-section');
            const deliveryInfo = document.getElementById('delivery-info');
            const totalWithDelivery = document.getElementById('total-with-delivery');
            
            // Resetar estado de pagamento
            state.paymentConfirmed = false;
            state.selectedPaymentMethod = null;
            resetPaymentUI();
            
            if (orderType === 'delivery') {
                addressSection.classList.remove('hidden');
                deliveryInfo.classList.remove('hidden');
                totalWithDelivery.classList.remove('hidden');
                toggleAddressMethod();
            } else {
                addressSection.classList.add('hidden');
                deliveryInfo.classList.add('hidden');
                totalWithDelivery.classList.add('hidden');
            }
            
            validateForm();
        }

        function toggleAddressMethod() {
            const method = document.getElementById('address-method').value;
            const manualSection = document.getElementById('manual-address-section');
            const gpsSection = document.getElementById('gps-section');
            
            if (method === 'manual') {
                manualSection.classList.remove('hidden');
                gpsSection.classList.add('hidden');
            } else {
                manualSection.classList.add('hidden');
                gpsSection.classList.remove('hidden');
            }
        }

        function getUserLocation() {
            const locationInfo = document.getElementById('location-info');
            const locationStatus = locationInfo.querySelector('span') || locationInfo;
            
            if (!navigator.geolocation) {
                locationStatus.textContent = '‚ùå Geolocaliza√ß√£o n√£o suportada pelo navegador';
                locationInfo.classList.remove('hidden');
                return;
            }
            
            locationStatus.textContent = 'üìç Obtendo localiza√ß√£o...';
            locationInfo.classList.remove('hidden');
            
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    state.userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    locationStatus.textContent = '‚úÖ Localiza√ß√£o obtida com sucesso!';
                    locationInfo.classList.add('info-message');
                    
                    // Calcular taxa de entrega
                    await calculateDeliveryFeeFromGPS();
                    validateForm();
                },
                (error) => {
                    console.error('Erro na geolocaliza√ß√£o:', error);
                    locationStatus.textContent = '‚ùå N√£o foi poss√≠vel obter a localiza√ß√£o. Tente digitar o endere√ßo manualmente.';
                    locationInfo.classList.add('error-message');
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        // ============================================
        // FUN√á√ïES DE PAGAMENTO (MELHORADAS)
        // ============================================
        function selectPaymentMethod(method) {
            state.selectedPaymentMethod = method;
            
            // Atualizar UI
            document.querySelectorAll('.payment-method').forEach(el => {
                el.classList.remove('selected');
                el.querySelector('input').checked = false;
            });
            
            const selectedElement = document.getElementById(`${method}-method`).parentElement;
            selectedElement.classList.add('selected');
            selectedElement.querySelector('input').checked = true;
            
            // Habilitar bot√£o de pagamento
            document.getElementById('pay-button').disabled = false;
            
            // Atualizar texto do bot√£o
            updatePayButtonText(method);
            
            validateForm();
        }

        function updatePayButtonText(method) {
            const buttonText = document.getElementById('pay-button-text');
            const orderType = document.getElementById('order-type').value;
            
            const texts = {
                pix: 'üßæ Pagar com PIX Online',
                cash: orderType === 'pickup' ? 'üíµ Confirmar Pagamento na Retirada' : 'üíµ Confirmar Pagamento na Entrega',
                card: orderType === 'pickup' ? 'üí≥ Confirmar Pagamento na Retirada' : 'üí≥ Confirmar Pagamento na Entrega'
            };
            
            buttonText.innerHTML = texts[method] || 'üí∞ Realizar Pagamento';
        }

        async function processPayment() {
            if (state.paymentProcessing) return;
            
            // Validar antes de processar
            const validationErrors = validateOrderBeforePayment();
            if (validationErrors.length > 0) {
                alert(validationErrors.join('\n'));
                return;
            }
            
            state.paymentProcessing = true;
            const payButton = document.getElementById('pay-button');
            const originalText = document.getElementById('pay-button-text').innerHTML;
            
            // Mostrar loading
            document.getElementById('pay-button-text').innerHTML = '<span class="payment-loading"></span> Processando...';
            payButton.disabled = true;
            
            // Status UI
            const paymentStatus = document.getElementById('payment-status');
            paymentStatus.classList.remove('hidden');
            paymentStatus.className = 'payment-status';
            paymentStatus.innerHTML = 'üîÑ Processando seu pagamento...';
            
            try {
                if (state.selectedPaymentMethod === 'pix') {
                    await processPixPayment();
                } else {
                    await processLocalPayment();
                }
            } catch (error) {
                handlePaymentError(error, originalText, payButton);
            }
        }

        function validateOrderBeforePayment() {
            const errors = [];
            const customerName = document.getElementById('customer-name').value.trim();
            const orderType = document.getElementById('order-type').value;
            
            if (!customerName) errors.push('‚Ä¢ Digite seu nome completo');
            if (state.cart.length === 0) errors.push('‚Ä¢ Adicione itens ao carrinho');
            
            if (orderType === 'delivery') {
                const addressMethod = document.getElementById('address-method').value;
                
                if (addressMethod === 'gps' && !state.userLocation) {
                    errors.push('‚Ä¢ Obtenha sua localiza√ß√£o GPS primeiro');
                }
                
                if (addressMethod === 'manual') {
                    const address = document.getElementById('customer-address').value.trim();
                    if (!address) errors.push('‚Ä¢ Digite o endere√ßo de entrega completo');
                }
            }
            
            if (!state.selectedPaymentMethod) errors.push('‚Ä¢ Selecione um m√©todo de pagamento');
            
            return errors;
        }

        async function processPixPayment() {
            try {
                const orderData = prepareOrderData();
                let response;
                
                // Verificar se estamos em desenvolvimento local
                if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                    // Usar mock para desenvolvimento
                    response = await fetch('/api/mock-payment', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            amount: orderData.total,
                            method: 'pix'
                        })
                    });
                } else {
                    // Produ√ß√£o - usar API real
                    response = await fetch(CONFIG.paymentApiUrl + '/create-payment', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(orderData)
                    });
                }
                
                if (!response.ok) throw new Error(`API error: ${response.status}`);
                
                const paymentData = await response.json();
                showPixQRCode(paymentData);
                
            } catch (error) {
                console.error('Erro no PIX:', error);
                throw new Error('N√£o foi poss√≠vel gerar o PIX. Tente outro m√©todo.');
            }
        }

        function showPixQRCode(paymentData) {
            const paymentStatus = document.getElementById('payment-status');
            
            paymentStatus.className = 'payment-status success';
            paymentStatus.innerHTML = `
                <div style="text-align: center;">
                    <h4 style="margin-bottom: 15px; color: #28a745;">‚úÖ PIX GERADO</h4>
                    <img src="${paymentData.qrCode}" alt="QR Code PIX" 
                         style="max-width: 200px; border: 2px solid #ddd; padding: 10px; background: white; border-radius: 10px;">
                    <p style="margin: 10px 0; font-size: 13px; color: #666;">
                        Escaneie com seu app banc√°rio
                    </p>
                    
                    <div style="background: rgba(0,0,0,0.1); padding: 10px; border-radius: 8px; margin: 15px 0;">
                        <div style="font-size: 12px; color: #888; margin-bottom: 5px;">C√ìDIGO PIX (copie e cole):</div>
                        <code style="display: block; padding: 8px; background: white; border-radius: 5px; 
                               word-break: break-all; font-size: 11px; color: #333;">
                            ${paymentData.pixCode}
                        </code>
                    </div>
                    
                    <button onclick="copyPixCode('${paymentData.pixCode.replace(/'/g, "\\'")}')" 
                            style="background: #4d96ff; color: white; border: none; padding: 10px; 
                                   border-radius: 5px; cursor: pointer; width: 100%; margin: 5px 0;">
                        üìã Copiar C√≥digo PIX
                    </button>
                    
                    <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,0,0.1); 
                                border-radius: 5px; font-size: 12px;">
                        ‚è±Ô∏è Aguarde a confirma√ß√£o autom√°tica...
                    </div>
                </div>
            `;
            
            if (paymentData.paymentId) {
                checkPaymentStatus(paymentData.paymentId);
            }
        }

        async function processLocalPayment() {
            // Simular processamento
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            const paymentStatus = document.getElementById('payment-status');
            paymentStatus.className = 'payment-status success';
            
            const orderType = document.getElementById('order-type').value;
            const locationText = orderType === 'pickup' ? 'retirada' : 'entrega';
            
            paymentStatus.innerHTML = `‚úÖ Pagamento confirmado para ${locationText}!`;
            
            state.paymentConfirmed = true;
            enableWhatsAppButton();
            
            // Atualizar UI
            document.getElementById('pay-button-text').innerHTML = '‚úÖ Pagamento Confirmado';
            document.getElementById('pay-button').disabled = true;
            state.paymentProcessing = false;
            
            // Feedback
            const methodText = state.selectedPaymentMethod === 'cash' ? 'dinheiro' : 'cart√£o';
            alert(`‚úÖ Pagamento confirmado!\n\nVoc√™ pagar√° em ${methodText} na ${locationText}.\n\nAgora envie o pedido para o WhatsApp!`);
        }

        function handlePaymentError(error, originalText, payButton) {
            console.error('Payment error:', error);
            
            const paymentStatus = document.getElementById('payment-status');
            paymentStatus.className = 'payment-status error';
            paymentStatus.innerHTML = `‚ùå ${error.message || 'Erro ao processar pagamento'}`;
            
            // Restaurar bot√£o
            document.getElementById('pay-button-text').innerHTML = originalText;
            payButton.disabled = false;
            state.paymentProcessing = false;
        }

        function copyPixCode(pixCode) {
            navigator.clipboard.writeText(pixCode).then(() => {
                alert('‚úÖ C√≥digo PIX copiado! Cole no seu app banc√°rio.');
            }).catch(err => {
                console.error('Copy failed:', err);
                alert('‚ùå N√£o foi poss√≠vel copiar. Anote o c√≥digo manualmente.');
            });
        }

        function resetPaymentUI() {
            document.querySelectorAll('.payment-method').forEach(el => {
                el.classList.remove('selected');
                el.querySelector('input').checked = false;
            });
            
            const payButton = document.getElementById('pay-button');
            payButton.disabled = true;
            document.getElementById('pay-button-text').innerHTML = 'üí∞ Realizar Pagamento';
            
            const paymentStatus = document.getElementById('payment-status');
            paymentStatus.classList.add('hidden');
            paymentStatus.innerHTML = '';
            
            const checkoutButton = document.getElementById('checkout-button');
            checkoutButton.disabled = true;
            checkoutButton.innerHTML = 'üì± Enviar Pedido para WhatsApp';
            
            state.selectedPaymentMethod = null;
            state.paymentConfirmed = false;
            state.paymentProcessing = false;
        }

        function enableWhatsAppButton() {
            const checkoutButton = document.getElementById('checkout-button');
            checkoutButton.disabled = false;
            checkoutButton.innerHTML = 'üì± Enviar Pedido para WhatsApp';
        }

        // ============================================
        // VALIDA√á√ÉO DO FORMUL√ÅRIO
        // ============================================
        function validateForm() {
            const customerName = document.getElementById('customer-name').value.trim();
            const orderType = document.getElementById('order-type').value;
            
            let isValid = customerName.length > 0 && state.cart.length > 0;
            
            if (orderType === 'delivery') {
                const addressMethod = document.getElementById('address-method').value;
                
                if (addressMethod === 'gps') {
                    isValid = isValid && state.userLocation !== null;
                } else if (addressMethod === 'manual') {
                    const address = document.getElementById('customer-address').value.trim();
                    isValid = isValid && address.length > 0;
                }
            }
            
            // Habilitar/desabilitar bot√£o de checkout baseado no pagamento
            const checkoutButton = document.getElementById('checkout-button');
            
            if (orderType === 'pickup') {
                // Para retirada, precisa de pagamento confirmado
                checkoutButton.disabled = !(isValid && state.paymentConfirmed);
            } else {
                // Para entrega, se for PIX precisa de confirma√ß√£o, se for dinheiro/cart√£o n√£o
                if (state.selectedPaymentMethod === 'pix') {
                    checkoutButton.disabled = !(isValid && state.paymentConfirmed);
                } else if (state.selectedPaymentMethod === 'cash' || state.selectedPaymentMethod === 'card') {
                    checkoutButton.disabled = !(isValid && state.selectedPaymentMethod !== null);
                } else {
                    checkoutButton.disabled = true;
                }
            }
            
            return isValid;
        }

        // ============================================
        // ENVIO PARA WHATSAPP
        // ============================================
        async function sendToWhatsApp() {
            // Valida√ß√£o final
            if (!validateForm()) {
                alert('Complete todas as informa√ß√µes antes de enviar!');
                return;
            }
            
            const orderType = document.getElementById('order-type').value;
            
            // Verificar pagamento
            if (orderType === 'pickup' && !state.paymentConfirmed) {
                alert('Confirme o pagamento antes de enviar!');
                return;
            }
            
            if (orderType === 'delivery' && state.selectedPaymentMethod === 'pix' && !state.paymentConfirmed) {
                alert('Confirme o pagamento PIX antes de enviar!');
                return;
            }
            
            // Preparar e enviar mensagem
            try {
                const message = await prepareWhatsAppMessage();
                const encodedMessage = encodeURIComponent(message);
                const whatsappUrl = `https://wa.me/${CONFIG.whatsappNumber}?text=${encodedMessage}`;
                
                window.open(whatsappUrl, '_blank');
                
                // Limpar ap√≥s envio
                resetOrder();
                alert('‚úÖ Pedido enviado! Aguarde nosso contato no WhatsApp.');
                
            } catch (error) {
                console.error('Erro ao enviar:', error);
                alert('‚ùå Erro ao preparar pedido. Tente novamente.');
            }
        }

        // ============================================
        // FUN√á√ïES AUXILIARES
        // ============================================
        function prepareOrderData() {
            const customerName = document.getElementById('customer-name').value.trim();
            const orderType = document.getElementById('order-type').value;
            const subtotal = calculateSubtotal();
            let total = subtotal;
            
            if (orderType === 'delivery') {
                const deliveryFee = parseFloat(document.getElementById('delivery-fee').textContent) || 0;
                total = subtotal + deliveryFee;
            }
            
            return {
                customerName: customerName,
                orderType: orderType,
                items: state.cart.map(item => ({
                    name: item.name,
                    quantity: item.quantity,
                    price: item.price,
                    total: item.price * item.quantity
                })),
                subtotal: subtotal,
                total: total,
                paymentMethod: state.selectedPaymentMethod,
                paymentConfirmed: state.paymentConfirmed,
                timestamp: new Date().toISOString()
            };
        }

        function resetOrder() {
            state.cart = [];
            state.userLocation = null;
            state.selectedPaymentMethod = null;
            state.paymentConfirmed = false;
            state.paymentProcessing = false;
            
            // Resetar campos
            document.getElementById('customer-name').value = '';
            document.getElementById('customer-address').value = '';
            document.getElementById('order-type').value = 'pickup';
            document.getElementById('address-method').value = 'gps';
            
            // Resetar UI
            updateCart();
            toggleDeliveryFields();
            toggleAddressMethod();
            resetPaymentUI();
            
            document.getElementById('delivery-info').classList.add('hidden');
            document.getElementById('total-with-delivery').classList.add('hidden');
            document.getElementById('location-info').classList.add('hidden');
        }

        function showError(message) {
            alert(`‚ùå ${message}`);
        }

        // ============================================
        // INICIALIZA√á√ÉO
        // ============================================
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>